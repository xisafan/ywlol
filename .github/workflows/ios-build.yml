name: ðŸŽ Build iOS App

on:
  # å¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æž„å»ºç±»åž‹'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release
  
  # æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches: [ main ]
  
  # PRæ—¶è§¦å‘
  pull_request:
    branches: [ main ]

jobs:
  build-ios:
    name: ðŸš€ Build iOS App
    runs-on: macos-14 # ä½¿ç”¨æœ€æ–°çš„macOS runner
    
    steps:
    - name: ðŸ“¦ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ“± Setup iOS build environment
      run: |
        # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        sw_vers
        xcodebuild -version
        echo "=== Xcodeè·¯å¾„ ==="
        xcode-select -p
        
    - name: ðŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3' # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬
        channel: 'stable'
        cache: true
        
    - name: ðŸ“‹ Flutter doctor
      run: |
        flutter doctor -v
        flutter --version
        
    - name: ðŸ“¦ Get dependencies
      run: |
        flutter pub get
        
    - name: ðŸ§¹ Clean build
      run: |
        flutter clean
        cd ios && rm -rf Pods Podfile.lock .symlinks && cd ..
        
    - name: ðŸ”¨ Pod install
      run: |
        cd ios
        pod install --repo-update
        cd ..
        
    - name: ðŸ› ï¸ Build iOS (Debug)
      if: ${{ github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == '' }}
      run: |
        flutter build ios --debug --no-codesign
        
    - name: ðŸ› ï¸ Build iOS (Release)
      if: ${{ github.event.inputs.build_type == 'release' }}
      run: |
        flutter build ios --release --no-codesign
        
    - name: ðŸ“ Create IPA (Debug)
      if: ${{ github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == '' }}
      run: |
        cd build/ios/iphoneos
        mkdir -p Payload
        cp -r Runner.app Payload/
        zip -r ovofun-debug.ipa Payload/
        mv ovofun-debug.ipa ../../../
        
    - name: ðŸ“ Create IPA (Release)
      if: ${{ github.event.inputs.build_type == 'release' }}
      run: |
        cd build/ios/iphoneos
        mkdir -p Payload
        cp -r Runner.app Payload/
        zip -r ovofun-release.ipa Payload/
        mv ovofun-release.ipa ../../../
        
    - name: ðŸ“Š Build info
      run: |
        echo "=== æž„å»ºä¿¡æ¯ ==="
        ls -la *.ipa || echo "æœªæ‰¾åˆ°IPAæ–‡ä»¶"
        if [ -f ovofun-debug.ipa ]; then
          echo "Debug IPAå¤§å°: $(du -h ovofun-debug.ipa | cut -f1)"
        fi
        if [ -f ovofun-release.ipa ]; then
          echo "Release IPAå¤§å°: $(du -h ovofun-release.ipa | cut -f1)"
        fi
        
    - name: ðŸ”„ Upload Debug IPA
      if: ${{ github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == '' }}
      uses: actions/upload-artifact@v4
      with:
        name: ovofun-ios-debug
        path: ovofun-debug.ipa
        retention-days: 30
        
    - name: ðŸ”„ Upload Release IPA
      if: ${{ github.event.inputs.build_type == 'release' }}
      uses: actions/upload-artifact@v4
      with:
        name: ovofun-ios-release
        path: ovofun-release.ipa
        retention-days: 30
        
    - name: ðŸ“ Create Release (ä»…Releaseæž„å»º)
      if: ${{ github.event.inputs.build_type == 'release' && github.ref == 'refs/heads/main' }}
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ios-v${{ github.run_number }}
        release_name: iOS Release v${{ github.run_number }}
        body: |
          ðŸŽ **iOSåº”ç”¨è‡ªåŠ¨æž„å»ºå‘å¸ƒ**
          
          ðŸ“± **åº”ç”¨ä¿¡æ¯:**
          - åº”ç”¨åç§°: Ovofun
          - æž„å»ºç±»åž‹: Release
          - æž„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          
          ðŸ“¦ **å®‰è£…è¯´æ˜Ž:**
          1. ä¸‹è½½ `ovofun-release.ipa` æ–‡ä»¶
          2. ä½¿ç”¨ AltStoreã€TrollStore æˆ–å…¶ä»–ç­¾åå·¥å…·å®‰è£…
          3. é¦–æ¬¡å®‰è£…éœ€è¦ä¿¡ä»»å¼€å‘è€…è¯ä¹¦
          
          âš ï¸ **æ³¨æ„äº‹é¡¹:**
          - è¿™æ˜¯æœªç­¾åç‰ˆæœ¬ï¼Œéœ€è¦è‡ªè¡Œç­¾åæˆ–ä½¿ç”¨è¶Šç‹±è®¾å¤‡
          - ä»…ä¾›æµ‹è¯•ä½¿ç”¨ï¼Œä¸å¯ç”¨äºŽç”Ÿäº§çŽ¯å¢ƒ
          
          ðŸ”§ **æŠ€æœ¯ä¿¡æ¯:**
          - Flutterç‰ˆæœ¬: 3.24.3
          - iOSæœ€ä½Žç‰ˆæœ¬: 13.0
          - æž„å»ºçŽ¯å¢ƒ: macOS-14
        draft: false
        prerelease: true
        
  build-summary:
    name: ðŸ“‹ Build Summary
    runs-on: ubuntu-latest
    needs: build-ios
    if: always()
    
    steps:
    - name: ðŸ“Š Summary
      run: |
        echo "## ðŸŽ iOSæž„å»ºå®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| iOSæž„å»º | ${{ needs.build-ios.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.build-ios.result }}" == "success" ]; then
          echo "### ðŸŽ‰ æž„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“± **ä¸‹è½½æ–¹å¼:**" >> $GITHUB_STEP_SUMMARY
          echo "- åœ¨Actionsé¡µé¢ä¸‹è½½æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "- æ–‡ä»¶å: ovofun-*.ipa" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ **å®‰è£…æ–¹æ³•:**" >> $GITHUB_STEP_SUMMARY
          echo "1. ä½¿ç”¨AltStoreæˆ–ç±»ä¼¼å·¥å…·ç­¾åå®‰è£…" >> $GITHUB_STEP_SUMMARY
          echo "2. æˆ–è€…ä½¿ç”¨Xcodeç›´æŽ¥å®‰è£…åˆ°è®¾å¤‡" >> $GITHUB_STEP_SUMMARY
          echo "3. ä¿¡ä»»å¼€å‘è€…è¯ä¹¦åŽå³å¯ä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ æž„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—æŽ’æŸ¥é—®é¢˜ã€‚å¸¸è§é—®é¢˜:" >> $GITHUB_STEP_SUMMARY
          echo "- ä¾èµ–ç‰ˆæœ¬å†²çª" >> $GITHUB_STEP_SUMMARY
          echo "- iOSé…ç½®é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          echo "- Xcodeç‰ˆæœ¬ä¸åŒ¹é…" >> $GITHUB_STEP_SUMMARY
        fi
