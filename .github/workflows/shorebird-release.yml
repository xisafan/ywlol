name: 🚀 Shorebird Hot Update Release

on:
  workflow_dispatch:
    inputs:
      update_message:
        description: "更新说明"
        required: true
        default: "修复bug和性能优化"

jobs:
  shorebird-release:
    name: 📱 发布热更新
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout repository
        uses: actions/checkout@v4

      - name: 🔧 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: 📱 Install Shorebird
        run: |
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          echo "$HOME/.shorebird/bin" >> $GITHUB_PATH

      - name: 🔑 Setup Shorebird Token
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
        run: |
          echo "Token configured for Shorebird"
          shorebird doctor

      - name: 📦 Get dependencies
        run: flutter pub get

      - name: 🚀 Release hot update (Android)
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
        run: |
          shorebird release android --flutter-version=$(flutter --version --machine | jq -r '.flutterVersion')

      - name: 🍎 Release hot update (iOS)
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
        run: |
          shorebird release ios --flutter-version=$(flutter --version --machine | jq -r '.flutterVersion')

      - name: 📝 Create patch (示例)
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
        run: |
          echo "可以在这里创建热更新补丁"
          echo "shorebird patch android --release-version=1.0.0+1"
          echo "shorebird patch ios --release-version=1.0.0+1"
