name: iOS-ipa-build

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  build-ios:
    name: ğŸ‰ iOS Build
    runs-on: macos-latest  # å¿…é¡»ä½¿ç”¨ macOS ç¯å¢ƒæ„å»º iOS åº”ç”¨
    steps:
      # 1. æ£€å‡ºä»£ç ä»“åº“
      - name: Checkout repository code
        uses: actions/checkout@v3

      # 2. å®‰è£… Flutter ç¯å¢ƒï¼ˆç¨³å®šç‰ˆï¼Œx64 æ¶æ„ï¼‰
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'  # ä½¿ç”¨ Flutter ç¨³å®šç‰ˆ
          architecture: x64  # é€‚é… macOS æœ€æ–°ç¯å¢ƒæ¶æ„

      # 3. å®‰è£… Flutter é¡¹ç›®ä¾èµ–
      - name: Install Flutter dependencies
        run: flutter pub get

      # 4. é…ç½® Xcode é¡¹ç›®ï¼ˆç¦ç”¨ç­¾åï¼Œé¿å…æ„å»ºæŠ¥é”™ï¼‰
      - name: Configure Xcode project (disable code signing)
        run: |
          cd ios  # è¿›å…¥ iOS é¡¹ç›®ç›®å½•
          # é€šè¿‡ xcodebuild å‘½ä»¤è®¾ç½®ç­¾åç›¸å…³å‚æ•°ï¼Œè·³è¿‡ç­¾åæ£€æŸ¥
          xcodebuild -workspace Runner.xcworkspace -scheme Runner -configuration Release \
            DEVELOPMENT_TEAM="" \  # ç©ºå¼€å‘å›¢é˜Ÿï¼ˆé€‚é…æ— å¼€å‘è€…è´¦å·åœºæ™¯ï¼‰
            CODE_SIGN_IDENTITY="" \  # ç©ºç­¾åèº«ä»½
            CODE_SIGNING_REQUIRED=NO \  # ç¦ç”¨ç­¾åè¦æ±‚
            CODE_SIGNING_ALLOWED=NO    # ä¸å…è®¸ç­¾å

      # 5. æ›´æ–° CocoaPods ä»“åº“å¹¶å®‰è£… iOS ä¾èµ–
      - name: Update CocoaPods repo
        run: pod repo update
        working-directory: ios  # é™å®šåœ¨ ios ç›®å½•æ‰§è¡Œ

      - name: Install iOS dependencies (CocoaPods)
        run: pod install
        working-directory: ios  # å®‰è£… Podfile ä¸­çš„ä¾èµ–

      # 6. æ„å»º iOS Release ç‰ˆæœ¬ï¼ˆæ— ç­¾åï¼‰
      - name: Build iOS Release version (no codesign)
        run: flutter build ios --release --no-codesign --verbose  # --verbose ä¾¿äºè°ƒè¯•æ„å»ºé—®é¢˜

      # 7. æ„å»º IPA åŒ…ç»“æ„ï¼ˆiOS è¦æ±‚ IPA éœ€åŒ…å« Payload ç›®å½•ï¼‰
      - name: Create IPA directory structure
        run: mkdir -p build/ios/iphoneos/Payload  # åˆ›å»º Payload ç›®å½•ï¼ˆç¡®ä¿è·¯å¾„å­˜åœ¨ï¼‰

      - name: Move app to Payload directory
        run: mv build/ios/iphoneos/Runner.app build/ios/iphoneos/Payload/  # å°† Runner.app ç§»å…¥ Payload

      # 8. å‹ç¼©ä¸º IPA æ–‡ä»¶ï¼ˆ-9 è¡¨ç¤ºæœ€é«˜å‹ç¼©ç‡ï¼Œ-qq å‡å°‘è¾“å‡ºæ—¥å¿—ï¼‰
      - name: Zip to IPA file
        run: zip -qq -r -9 FlutterIpaExport.ipa Payload
        working-directory: build/ios/iphoneos  # åœ¨ iphoneos ç›®å½•æ‰§è¡Œå‹ç¼©

      # 9. ä¸Šä¼  IPA åˆ° GitHub Actions äº§ç‰©ï¼ˆä½¿ç”¨ v4 ç‰ˆæœ¬ï¼Œä¿®å¤å¼ƒç”¨é—®é¢˜ï¼‰
      - name: Upload IPA to workflow artifacts
        uses: actions/upload-artifact@v4  # å…³é”®ï¼šå‡çº§ä¸º v4 ç‰ˆæœ¬ï¼Œé¿å…å¼ƒç”¨æŠ¥é”™
        with:
          name: flutter-ios-ipa  # äº§ç‰©åç§°ï¼ˆä¸‹è½½æ—¶æ˜¾ç¤ºï¼‰
          path: build/ios/iphoneos/FlutterIpaExport.ipa  # IPA æ–‡ä»¶è·¯å¾„
          retention-days: 30  # äº§ç‰©ä¿ç•™ 30 å¤©ï¼ˆå¯é€‰ï¼Œé»˜è®¤ 90 å¤©ï¼‰

      # 10. ä¸Šä¼  IPA åˆ° GitHub Releaseï¼ˆå¦‚éœ€å‘å¸ƒåˆ° Release é¡µï¼Œå¯ä¿ç•™æ­¤æ­¥éª¤ï¼‰
      - name: Upload IPA to GitHub Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}  # GitHub è‡ªåŠ¨ç”Ÿæˆçš„ Tokenï¼ˆæ— éœ€æ‰‹åŠ¨é…ç½®ï¼‰
          file: build/ios/iphoneos/FlutterIpaExport.ipa  # IPA æ–‡ä»¶è·¯å¾„
          tag: v1.0  # Release æ ‡ç­¾ï¼ˆéœ€ç¡®ä¿æ ‡ç­¾å·²åˆ›å»ºï¼Œæˆ–å…ˆé€šè¿‡æ­¥éª¤åˆ›å»ºï¼‰
          overwrite: true  # å…è®¸è¦†ç›–åŒæ ‡ç­¾ä¸‹çš„æ—§æ–‡ä»¶
          body: "This is the first iOS IPA release (built via GitHub Actions)"  # Release æè¿°
