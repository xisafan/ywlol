name: iOS-ipa-build

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: ğŸ‰ iOS Build
    runs-on: macos-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v3

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      # 1. æ·±åº¦æ¸…ç†é¡¹ç›®ç¼“å­˜
      - name: Deep clean project
        run: |
          flutter clean
          rm -rf ios/Pods ios/Podfile.lock ios/.symlinks ios/Flutter/Flutter.framework
          rm -rf ~/Library/Developer/Xcode/DerivedData/* ~/Library/Caches/CocoaPods
          rm -rf ~/.pub-cache

      # 2. å®‰è£…Flutterä¾èµ–
      - name: Install Flutter dependencies
        run: flutter pub get

      # 3. ç”Ÿæˆæ ‡å‡†Podfile
      - name: Generate standard Podfile
        run: |
          cd ios
          if [ ! -f "Podfile" ]; then
            cat > Podfile <<EOF
          platform :ios, '11.0'
          ENV['COCOAPODS_DISABLE_STATS'] = 'true'

          project 'Runner', {
            'Debug' => :debug,
            'Profile' => :release,
            'Release' => :release,
          }

          def flutter_root
            generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
            unless File.exist?(generated_xcode_build_settings_path)
              raise "#{generated_xcode_build_settings_path} must exist. Run 'flutter pub get' first."
            end

            File.foreach(generated_xcode_build_settings_path) do |line|
              matches = line.match(/FLUTTER_ROOT\=(.*)/)
              return matches[1].strip if matches
            end
            raise "FLUTTER_ROOT not found in #{generated_xcode_build_settings_path}"
          end

          require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)

          target 'Runner' do
            use_frameworks!
            use_modular_headers!
            flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
          end

          post_install do |installer|
            installer.pods_project.targets.each do |target|
              flutter_additional_ios_build_settings(target)
            end
          end
          EOF
            if [ -f "Podfile" ]; then
              echo "âœ… Podfile generated successfully"
            else
              echo "âŒ Failed to generate Podfile"
              exit 1
            fi
          else
            echo "âœ… Podfile exists, skipping generation"
          fi

      # 4. å®‰è£…CocoaPodsä¾èµ–
      - name: Install CocoaPods dependencies
        run: |
          cd ios
          sudo gem install cocoapods --no-document
          pod repo update --verbose
          pod install --verbose --repo-update
          
          if [ -f "Pods/Target Support Files/Pods-Runner/Pods-Runner-frameworks-Release-input-files.xcfilelist" ]; then
            echo "âœ… Required xcfilelist files exist"
            chmod -R 777 Pods/Target\ Support\ Files/
          else
            echo "âŒ Missing required xcfilelist files"
            exit 1
          fi

      # 5. æ„å»ºiOSç‰ˆæœ¬ï¼ˆä¸æŒ‡å®šè¾“å‡ºè·¯å¾„ï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„ï¼‰
      - name: Build iOS Release
        run: |
          # ç§»é™¤æ‰€æœ‰è·¯å¾„å‚æ•°ï¼Œä½¿ç”¨Flutteré»˜è®¤æ„å»ºè·¯å¾„
          flutter build ios --release --no-codesign --verbose
          
          # éªŒè¯æ„å»ºäº§ç‰©ï¼ˆFlutteré»˜è®¤è·¯å¾„ï¼‰
          DEFAULT_PATH="build/ios/iphoneos"
          if [ -d "$DEFAULT_PATH/Runner.app" ]; then
            echo "âœ… Build successful. App path: $DEFAULT_PATH"
          else
            echo "âŒ Build failed - Runner.app not found in $DEFAULT_PATH"
            exit 1
          fi

      # 6. æ‰“åŒ…IPAï¼ˆä½¿ç”¨Flutteré»˜è®¤æ„å»ºè·¯å¾„ï¼‰
      - name: Package IPA
        run: |
          # ä½¿ç”¨Flutteré»˜è®¤æ„å»ºè·¯å¾„
          BUILD_PATH="build/ios/iphoneos"
          mkdir -p "$BUILD_PATH/Payload"
          mv "$BUILD_PATH/Runner.app" "$BUILD_PATH/Payload/"
          cd "$BUILD_PATH"
          zip -qq -r -9 FlutterIpaExport.ipa Payload
          
          if [ -f "FlutterIpaExport.ipa" ]; then
            echo "âœ… IPA created: $(du -sh FlutterIpaExport.ipa)"
          else
            echo "âŒ Failed to create IPA"
            exit 1
          fi

      # 7. ä¸Šä¼ äº§ç‰©
      - name: Upload IPA to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flutter-ios-ipa
          path: build/ios/iphoneos/FlutterIpaExport.ipa
          retention-days: 30
    
