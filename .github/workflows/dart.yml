name: iOS-ipa-build

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: ğŸ‰ iOS Build
    runs-on: macos-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v3

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      # 1. æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯ï¼ˆç¡®è®¤Flutteræ ¹ç›®å½•ï¼‰
      - name: Show environment info
        run: |
          flutter --version
          xcodebuild -version
          pod --version
          echo "Flutter root path: $(flutter root)"  # éªŒè¯Flutteræ ¹ç›®å½•æ˜¯å¦æ­£ç¡®

      # 2. æ·±åº¦æ¸…ç†é¡¹ç›®
      - name: Deep clean project
        run: |
          flutter clean
          rm -rf ios/Pods ios/Podfile.lock ios/.symlinks ~/.pub-cache
          rm -rf ~/Library/Developer/Xcode/DerivedData/* ~/Library/Caches/CocoaPods
          rm -rf ios/Flutter/Flutter.podspec

      # 3. é…ç½®CocoaPodså›½å†…CDNé•œåƒï¼ˆä¿®å¤config.yamlä¸å­˜åœ¨é—®é¢˜ï¼‰
      - name: Configure CocoaPods with TUNA CDN mirror
        run: |
          mkdir -p ~/.cocoapods  # ç¡®ä¿é…ç½®ç›®å½•å­˜åœ¨
          # åˆå§‹åŒ–/å¤‡ä»½é…ç½®æ–‡ä»¶
          if [ ! -f ~/.cocoapods/config.yaml ]; then
            echo "---" > ~/.cocoapods/config.yaml
            echo "Initializing CocoaPods config"
          else
            cp ~/.cocoapods/config.yaml ~/.cocoapods/config.yaml.bak
            echo "Backed up CocoaPods config"
          fi
          # è®¾ç½®å›½å†…CDN
          sed -i '' '/cdn_url:/d' ~/.cocoapods/config.yaml
          echo "cdn_url: 'https://mirrors.tuna.tsinghua.edu.cn/git/CocoaPods/Specs.git'" >> ~/.cocoapods/config.yaml
          echo "Final CocoaPods config:"
          cat ~/.cocoapods/config.yaml
          # æ¸…ç†æ—§ç¼“å­˜
          rm -rf ~/.cocoapods/repos/*

      # 4. åŒæ­¥Flutteré¡¹ç›®çš„iOSæœ€ä½ç‰ˆæœ¬
      - name: Sync Flutter iOS deployment target
        run: |
          # ä¿®æ”¹Flutterå…¨å±€é…ç½®
          FLUTTER_XCCONFIG="ios/Flutter/Generated.xcconfig"
          if [ -f "$FLUTTER_XCCONFIG" ]; then
            sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET=.*/IPHONEOS_DEPLOYMENT_TARGET=12.0/' "$FLUTTER_XCCONFIG"
            echo "âœ… Updated $FLUTTER_XCCONFIG to iOS 12.0"
          else
            mkdir -p ios/Flutter
            echo "IPHONEOS_DEPLOYMENT_TARGET=12.0" > "$FLUTTER_XCCONFIG"
            echo "FLUTTER_ROOT=$(flutter root)" >> "$FLUTTER_XCCONFIG"
            echo "âœ… Created $FLUTTER_XCCONFIG"
          fi

          # ä¿®æ”¹Runner.xcodeproj
          cd ios
          sudo gem install xcodeproj --no-document
          ruby -e '
            require "xcodeproj"
            project = Xcodeproj::Project.open("Runner.xcodeproj")
            # é¡¹ç›®çº§éƒ¨ç½²ç›®æ ‡
            project.build_configurations.each { |c| c.build_settings["IPHONEOS_DEPLOYMENT_TARGET"] = "12.0" }
            # æ‰€æœ‰targetéƒ¨ç½²ç›®æ ‡
            project.targets.each { |t| t.build_configurations.each { |c| c.build_settings["IPHONEOS_DEPLOYMENT_TARGET"] = "12.0" } }
            project.save
            puts "âœ… Updated Runner.xcodeproj to iOS 12.0"
          '

      # 5. å®‰è£…Flutterä¾èµ–ï¼ˆç”Ÿæˆæ­£ç¡®çš„Flutteré…ç½®ï¼‰
      - name: Install Flutter dependencies
        run: |
          export IPHONEOS_DEPLOYMENT_TARGET=12.0
          flutter pub get
          # éªŒè¯Generated.xcconfigæ˜¯å¦ç”Ÿæˆ
          if [ ! -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "âŒ Generated.xcconfig missing! Flutter pub get failed"
            exit 1
          fi
          # éªŒè¯bonsoir_darwinä¾èµ–
          if grep -q "bonsoir_darwin" pubspec.lock; then
            echo "âœ… bonsoir_darwin found in pubspec.lock"
          else
            echo "âŒ bonsoir_darwin missing"
            cat pubspec.lock
            exit 1
          fi

      # 6. å…³é”®ä¿®å¤ï¼šç”Ÿæˆè·¯å¾„æ­£ç¡®çš„Podfileï¼ˆä¿®å¤podhelper.rbè·¯å¾„ï¼‰
      - name: Generate Podfile with correct podhelper path
        run: |
          cd ios
          # è·å–æ­£ç¡®çš„Flutteræ ¹ç›®å½•ï¼ˆé¿å…è·¯å¾„è®¡ç®—é”™è¯¯ï¼‰
          FLUTTER_ROOT=$(flutter root)
          echo "Using Flutter root: $FLUTTER_ROOT"
          
          cat > Podfile <<EOF
          platform :ios, '12.0'
          ENV['COCOAPODS_DISABLE_STATS'] = 'true'
          source 'https://mirrors.tuna.tsinghua.edu.cn/git/CocoaPods/Specs.git'  # å›½å†…CDNæº

          project 'Runner', { 'Debug' => :debug, 'Profile' => :release, 'Release' => :release }

          # å…³é”®ä¿®å¤ï¼šæ­£ç¡®è®¡ç®—podhelper.rbè·¯å¾„ï¼ˆåŸºäºFlutteræ ¹ç›®å½•ï¼‰
          def flutter_root
            # ä»Generated.xcconfigè¯»å–Flutteræ ¹ç›®å½•ï¼ˆæ›´å¯é ï¼‰
            generated_xcconfig = File.expand_path('../Flutter/Generated.xcconfig', __FILE__)
            unless File.exist?(generated_xcconfig)
              raise "Generated.xcconfig not found! Run 'flutter pub get' first."
            end
            File.foreach(generated_xcconfig) do |line|
              match = line.match(/FLUTTER_ROOT\=(.*)/)
              return match[1].strip if match
            end
            raise "FLUTTER_ROOT not found in Generated.xcconfig"
          end

          # å…³é”®ä¿®å¤ï¼šæ­£ç¡®å¼•å…¥podhelper.rbï¼ˆè·¯å¾„åŸºäºflutter_rootï¼Œè€Œéå½“å‰ç›®å½•ï¼‰
          podhelper_path = File.join(flutter_root, 'packages', 'flutter_tools', 'bin', 'podhelper.rb')
          unless File.exist?(podhelper_path)
            raise "podhelper.rb not found at #{podhelper_path}! Check Flutter installation."
          end
          require podhelper_path

          target 'Runner' do
            use_frameworks!
            use_modular_headers!
            # å®‰è£…Flutteræ’ä»¶ä¾èµ–ï¼ˆä¾èµ–podhelper.rbï¼‰
            flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
          end

          post_install do |installer|
            installer.pods_project.targets.each do |target|
              flutter_additional_ios_build_settings(target)
              # ç»Ÿä¸€æ’ä»¶é…ç½®
              target.build_configurations.each do |config|
                config.build_settings["IPHONEOS_DEPLOYMENT_TARGET"] = "12.0"
                config.build_settings["DEVELOPMENT_TEAM"] = ""
                config.build_settings["CODE_SIGNING_REQUIRED"] = "NO"
                config.build_settings["CODE_SIGNING_ALLOWED"] = "NO"
                config.build_settings["OTHER_SWIFT_FLAGS"] ||= []
                config.build_settings["OTHER_SWIFT_FLAGS"] << "-DGLES_SILENCE_DEPRECATION"
              end
            end
          end
          EOF
          echo "âœ… Podfile generated with correct podhelper path"
          # éªŒè¯podhelper.rbè·¯å¾„æ˜¯å¦å­˜åœ¨
          PODHELPER_PATH=$(ruby -e '
            require "fileutils"
            generated_xcconfig = File.expand_path("../Flutter/Generated.xcconfig", __FILE__)
            flutter_root = File.foreach(generated_xcconfig).find { |l| l.match(/FLUTTER_ROOT/) }.match(/FLUTTER_ROOT\=(.*)/)[1].strip
            puts File.join(flutter_root, "packages", "flutter_tools", "bin", "podhelper.rb")
          ')
          if [ -f "$PODHELPER_PATH" ]; then
            echo "âœ… podhelper.rb found at: $PODHELPER_PATH"
          else
            echo "âŒ podhelper.rb missing at: $PODHELPER_PATH"
            exit 1
          fi

      # 7. å®‰è£…CocoaPodsä¾èµ–ï¼ˆè·¯å¾„å·²ä¿®å¤ï¼‰
      - name: Install CocoaPods dependencies
        run: |
          cd ios
          export IPHONEOS_DEPLOYMENT_TARGET=12.0
          # éªŒè¯Podfileè¯­æ³•
          pod lint --allow-warnings Podfile
          # æ‰§è¡Œå®‰è£…
          pod install --verbose
          # éªŒè¯ä¾èµ–å®‰è£…
          if [ -d "Pods/bonsoir_darwin" ]; then
            echo "âœ… bonsoir_darwin pod installed"
          else
            echo "âŒ bonsoir_darwin pod missing"
            ls -la Pods/
            exit 1
          fi

      # 8. æ„å»ºiOS
      - name: Build iOS with xcodebuild
        run: |
          cd ios
          xcodebuild build \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build/DerivedData \
            -archivePath build/Runner.xcarchive \
            IPHONEOS_DEPLOYMENT_TARGET=12.0 \
            DEVELOPMENT_TEAM="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            OTHER_SWIFT_FLAGS="-DGLES_SILENCE_DEPRECATION" \
            clean \
            -verbose

      # 9. æ‰“åŒ…IPA
      - name: Package IPA
        run: |
          APP_PATH="ios/build/Products/Release-iphoneos/Runner.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ Runner.app not found at $APP_PATH"
            exit 1
          fi
          IPA_DIR="ios/build/ipa"
          mkdir -p "$IPA_DIR/Payload"
          mv "$APP_PATH" "$IPA_DIR/Payload/"
          cd "$IPA_DIR"
          zip -qq -r -9 FlutterIpaExport.ipa Payload
          if [ -f "FlutterIpaExport.ipa" ]; then
            echo "âœ… IPA generated! Size: $(du -sh FlutterIpaExport.ipa)"
            cp FlutterIpaExport.ipa ../../build/ios/iphoneos/
          else
            echo "âŒ IPA generation failed"
            exit 1
          fi

      # 10. ä¸Šä¼ äº§ç‰©
      - name: Upload IPA to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flutter-ios-ipa
          path: ios/build/ios/iphoneos/FlutterIpaExport.ipa
          retention-days: 30
