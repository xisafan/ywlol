# 🔧 检测更新功能调试指南

## ✅ 问题修复

我已经修复了一个关键问题：

**问题**：API 路径不匹配  
**原因**：客户端使用`/v1/check_update`，但后端配置的是`/check_update`  
**修复**：将客户端 API 路径改回`/check_update`以匹配后端

## 🧪 测试更新弹窗的方法

### 方法 1：通过设置页面测试

1. 进入应用的**个人中心/设置页面**
2. 找到**"检测更新"**选项
3. 点击触发更新检测
4. 观察是否出现更新弹窗

### 方法 2：数据库测试（推荐）

在数据库的`qwq_version`表中插入一个较新版本的数据：

```sql
INSERT INTO `qwq_version`
(`platform`, `title`, `version`, `download_url`, `browser_url`, `description`, `package_size`, `force_update`, `status`, `create_time`)
VALUES
('android', 'QwQFun Android版 V2.0.8', '2.0.8',
 'https://download.qwqfun.com/qwqfun-v2.0.8.apk',
 'https://qwqfun.com/android-update',
 '紧急修复安全漏洞，建议立即更新。优化了内存使用，提升了应用启动速度。',
 '32.8MB', 0, 1, NOW());
```

### 方法 3：修改当前版本号

临时修改`pubspec.yaml`中的版本号为较低版本：

```yaml
version: 1.0.0+1 # 改为比数据库中更低的版本
```

## 🔍 调试检查清单

### 1. 网络连接检查

- ✅ 确保设备能访问 API 服务器
- ✅ 检查 API 基础 URL 配置是否正确

### 2. 后端数据检查

```sql
-- 检查是否有版本数据
SELECT * FROM `qwq_version` WHERE `platform` = 'android' AND `status` = 1 ORDER BY `create_time` DESC LIMIT 1;
```

### 3. API 响应检查

在浏览器或 Postman 中测试：

```
GET: https://your-api-domain.com/api/check_update?platform=android&version=1.0.0
```

预期响应：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "has_update": true,
    "platform": "android",
    "version": "2.0.8",
    "current_version": "1.0.0",
    "title": "QwQFun Android版 V2.0.8",
    "download_url": "https://download.qwqfun.com/qwqfun-v2.0.8.apk",
    "browser_url": "https://qwqfun.com/android-update",
    "description": "紧急修复安全漏洞...",
    "package_size": "32.8MB",
    "force_update": false,
    "update_time": "2025-09-19 20:50:38"
  }
}
```

## 🐛 常见问题排查

### 1. 弹窗不出现

**可能原因**：

- API 返回`has_update: false`
- 数据库中没有版本信息
- 网络请求失败
- 当前版本号>=最新版本

**解决方法**：

- 检查数据库版本数据
- 降低当前应用版本号
- 检查网络连接和 API 配置

### 2. 强制更新测试

在数据库中将`force_update`设为 1：

```sql
UPDATE `qwq_version` SET `force_update` = 1 WHERE `platform` = 'android';
```

### 3. 不同更新方式测试

**直接下载测试**：

- 确保`download_url`有效
- `browser_url`为空或无效

**浏览器更新测试**：

- 确保`browser_url`有效
- `download_url`为空

## 📱 测试不同场景

### 场景 1：有更新，非强制

- `has_update: true`
- `force_update: false`
- 应显示带关闭按钮的弹窗

### 场景 2：有更新，强制更新

- `has_update: true`
- `force_update: true`
- 应显示无关闭按钮的弹窗

### 场景 3：无更新

- `has_update: false`
- 应显示"已是最新版本"弹窗

### 场景 4：API 错误

- 网络错误或 API 返回错误
- 应显示"检查更新失败"弹窗

## 🎯 快速测试步骤

1. **准备测试数据**：在数据库插入新版本记录
2. **降低应用版本**：修改 pubspec.yaml 版本号
3. **重新编译**：`flutter clean && flutter run`
4. **触发检测**：点击设置中的"检测更新"
5. **验证弹窗**：确认弹窗正常显示和功能

## 🔧 调试代码添加

如需详细调试，可在`_checkForUpdates`方法中添加日志：

```dart
print('API Response: $resp');
print('Has Update: $hasUpdate');
print('Force Update: $forceUpdate');
print('Update URL: $updateUrl');
```

## ✅ 验证要点

- ✅ 弹窗正常显示
- ✅ 版本信息正确显示
- ✅ 按钮响应正常
- ✅ 关闭按钮根据 force_update 正确显示/隐藏
- ✅ 下载/浏览器打开功能正常
- ✅ 强制更新阻止返回

完成这些测试后，您的更新检测功能应该能够正常工作！🎉




