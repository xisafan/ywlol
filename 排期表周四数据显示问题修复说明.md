# æ’æœŸè¡¨å‘¨å››æ•°æ®æ˜¾ç¤ºé—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ¯ é—®é¢˜åˆ†æ

æ ¹æ®æä¾›çš„ API æ•°æ®åˆ†æï¼Œå‘ç°äº†æ’æœŸè¡¨ä¸­å‘¨å››æ•°æ®ä¸æ˜¾ç¤ºçš„é—®é¢˜ï¼š

### API æ•°æ®ç¡®è®¤

```json
"4": [
  {
    "vod_id": "193",
    "vod_name": "æ€’æ”¾çš„é’æ˜¥",
    ...
  },
  {
    "vod_id": "191",
    "vod_name": "è€å¨˜æ³ª",
    ...
  },
  // ... æ€»å…±8ä¸ªé¡¹ç›®
]
```

API è¿”å›çš„æ•°æ®æ˜¾ç¤ºå‘¨å››ï¼ˆkey: "4"ï¼‰ç¡®å®æœ‰ 8 ä¸ªè§†é¢‘é¡¹ç›®ï¼Œä½†åœ¨ç•Œé¢ä¸Šæ— æ³•æ˜¾ç¤ºã€‚

## ğŸ” é—®é¢˜æ ¹æº

### 1. ç¼“å­˜æœºåˆ¶é—®é¢˜

```dart
// âŒ é—®é¢˜ä»£ç ï¼šç¼“å­˜äº†ç©ºæ•°æ®
final Map<int, Widget> _cachedPages = {};

Widget _buildPageContent(int pageIndex) {
  // å¦‚æœç¼“å­˜äº†ç©ºé¡µé¢ï¼Œå³ä½¿æ•°æ®æ›´æ–°ä¹Ÿä¸ä¼šé‡æ–°æ„å»º
  _cachedPages[pageIndex] = RepaintBoundary(child: pageContent);
  return _cachedPages[pageIndex]!;
}
```

### 2. æ•°æ®æ›´æ–°æ—¶ç¼“å­˜æœªæ¸…ç†

```dart
// âŒ æ•°æ®æ›´æ–°æ—¶æ²¡æœ‰æ¸…ç©ºç¼“å­˜
setState(() {
  _scheduleData = newScheduleData;
  _loading = false;
  // ç¼ºå°‘ï¼š_cachedPages.clear();
});
```

### 3. PageView æ„å»ºé€»è¾‘é—®é¢˜

```dart
// âŒ ä¾èµ–ç¼“å­˜å¯èƒ½å¯¼è‡´è¿‡æœŸæ•°æ®
itemBuilder: (context, i) {
  return _cachedPages[i] ?? _buildPageContent(i);
},
```

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. ğŸ”„ ä¼˜åŒ–æ•°æ®è·å–æµç¨‹

#### ç¡®ä¿æ•°æ®æ›´æ–°æ—¶æ¸…ç©ºç¼“å­˜

```dart
Future<void> fetchSchedule() async {
  if (mounted) {
    setState(() {
      _loading = true;
      _error = null;
      _cachedPages.clear(); // âœ… æ¸…ç©ºæ‰€æœ‰ç¼“å­˜é¡µé¢
      _scheduleData = {};
    });
  }

  try {
    final response = await _apiManager.getSchedule();
    if (!mounted) return;

    final newScheduleData = await _processScheduleData(response);

    setState(() {
      _scheduleData = newScheduleData;
      _loading = false;
    });

    _preloadAdjacentPages();
  } catch (e) {
    if (mounted) {
      setState(() {
        _loading = false;
        _error = e.toString();
        _scheduleData = {};
        _cachedPages.clear(); // âœ… é”™è¯¯æ—¶ä¹Ÿæ¸…ç©ºç¼“å­˜
      });
    }
  }
}
```

#### å¼‚æ­¥æ•°æ®å¤„ç†é¿å… UI é˜»å¡

```dart
Future<Map<String, List<dynamic>>> _processScheduleData(Map<String, dynamic> response) async {
  return Future.microtask(() {
    final Map<String, List<dynamic>> scheduleData = {};

    if (response.containsKey('schedule')) {
      final scheduleMap = response['schedule'];
      if (scheduleMap is Map) {
        scheduleMap.forEach((key, value) {
          if (value is List) {
            scheduleData[key.toString()] = List<dynamic>.from(value);
            print('å¤„ç†æ’æœŸæ•°æ® - ç¬¬${key}å¤©: ${value.length}é¡¹');
          }
        });
      }
    }

    return scheduleData;
  });
}
```

### 2. ğŸ¨ ä¿®å¤é¡µé¢æ„å»ºé€»è¾‘

#### å¼ºåˆ¶é‡æ–°æ„å»ºé¡µé¢å†…å®¹

```dart
Widget _buildScheduleList() {
  return PageView.builder(
    controller: _pageController,
    itemCount: 7,
    onPageChanged: _onPageChanged,
    itemBuilder: (context, i) {
      // âœ… å¼ºåˆ¶é‡æ–°æ„å»ºé¡µé¢å†…å®¹ï¼Œé¿å…ç¼“å­˜é—®é¢˜
      return _buildPageContent(i);
    },
  );
}
```

#### ä¼˜åŒ–é¡µé¢å†…å®¹æ„å»º

```dart
Widget _buildPageContent(int pageIndex) {
  final key = (pageIndex + 1).toString();
  final dayList = _scheduleData[key] ?? [];

  // Debug: è¾“å‡ºå½“å‰é¡µé¢ä¿¡æ¯
  print('æ„å»ºé¡µé¢ $pageIndex (ç¬¬${key}å¤©): ${dayList.length}é¡¹æ•°æ®');

  Widget pageContent;

  if (dayList.isEmpty) {
    pageContent = _buildEmptyDay(pageIndex);
  } else {
    pageContent = _buildAnimeGrid(pageIndex, dayList);
  }

  // âœ… ç¼“å­˜é¡µé¢å†…å®¹ - ç¡®ä¿æ¯æ¬¡æ•°æ®æ›´æ–°æ—¶é‡æ–°æ„å»º
  final cachedContent = RepaintBoundary(child: pageContent);
  _cachedPages[pageIndex] = cachedContent;
  return cachedContent;
}
```

### 3. ğŸ› æ·»åŠ è°ƒè¯•æ—¥å¿—

#### é¡µé¢åˆ‡æ¢è°ƒè¯•

```dart
void _onPageChanged(int index) {
  if (_selectedDay != index + 1) {
    setState(() {
      _selectedDay = index + 1;
    });

    // Debug: è¾“å‡ºåˆ‡æ¢ä¿¡æ¯
    final key = (index + 1).toString();
    final dayList = _scheduleData[key] ?? [];
    print('åˆ‡æ¢åˆ°ç¬¬${index + 1}å¤©: ${dayList.length}é¡¹æ•°æ®');

    _preloadAdjacentPages();
  }
}
```

#### æ•°æ®å¤„ç†è°ƒè¯•

```dart
print('æ€»å…±å¤„ç†äº†${scheduleData.length}å¤©çš„æ•°æ®');
scheduleData.forEach((day, items) {
  print('ç¬¬${day}å¤©: ${items.length}é¡¹');
});
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

### é—®é¢˜è§£å†³ç¡®è®¤

âœ… **ç¼“å­˜æ¸…ç†**ï¼šæ•°æ®æ›´æ–°æ—¶å¼ºåˆ¶æ¸…ç©ºé¡µé¢ç¼“å­˜  
âœ… **å¼ºåˆ¶é‡å»º**ï¼šç§»é™¤ä¾èµ–è¿‡æœŸç¼“å­˜çš„é€»è¾‘  
âœ… **è°ƒè¯•æ—¥å¿—**ï¼šæ·»åŠ è¯¦ç»†æ—¥å¿—è·Ÿè¸ªæ•°æ®æµç¨‹  
âœ… **å¼‚æ­¥å¤„ç†**ï¼šé¿å…æ•°æ®å¤„ç†é˜»å¡ UI çº¿ç¨‹

### æ•°æ®æµç¨‹ä¼˜åŒ–

âœ… **API æ•°æ®è§£æ**ï¼šæ­£ç¡®è§£æ schedule å­—æ®µ  
âœ… **æ•°æ®æ˜ å°„**ï¼šç¡®ä¿ key-value æ­£ç¡®å¯¹åº”  
âœ… **é¡µé¢æ˜ å°„**ï¼špageIndex + 1 = æ•°æ® key  
âœ… **çŠ¶æ€ç®¡ç†**ï¼šmounted æ£€æŸ¥é¿å…å†…å­˜æ³„æ¼

### æ€§èƒ½ä¿æŒ

âœ… **RepaintBoundary**ï¼šä¿æŒé‡ç»˜ä¼˜åŒ–  
âœ… **å¼‚æ­¥æ•°æ®å¤„ç†**ï¼šé¿å…ä¸»çº¿ç¨‹é˜»å¡  
âœ… **é€‰æ‹©æ€§ç¼“å­˜**ï¼šåœ¨åˆé€‚æ—¶æœºä½¿ç”¨ç¼“å­˜  
âœ… **é¢„åŠ è½½æœºåˆ¶**ï¼šç›¸é‚»é¡µé¢é¢„åŠ è½½æå‡ä½“éªŒ

## ğŸ“Š æŠ€æœ¯è¦ç‚¹

### ç¼“å­˜ç­–ç•¥è°ƒæ•´

```dart
// æ•°æ®æ›´æ–°æ—¶æ¸…ç©ºç¼“å­˜
_cachedPages.clear();

// å¼ºåˆ¶é‡æ–°æ„å»ºè€Œéä¾èµ–ç¼“å­˜
return _buildPageContent(i);
```

### æ•°æ®å¤„ç†ä¼˜åŒ–

```dart
// å¼‚æ­¥å¤„ç†é¿å…UIé˜»å¡
Future<Map<String, List<dynamic>>> _processScheduleData() async {
  return Future.microtask(() {
    // æ•°æ®å¤„ç†é€»è¾‘
  });
}
```

### è°ƒè¯•ä¿¡æ¯å¢å¼º

```dart
// è¯¦ç»†çš„æ•°æ®å¤„ç†æ—¥å¿—
print('å¤„ç†æ’æœŸæ•°æ® - ç¬¬${key}å¤©: ${value.length}é¡¹');
print('åˆ‡æ¢åˆ°ç¬¬${index + 1}å¤©: ${dayList.length}é¡¹æ•°æ®');
```

## ğŸ‰ æœ€ç»ˆæ•ˆæœ

ç°åœ¨æ’æœŸè¡¨çš„å‘¨å››æ•°æ®åº”è¯¥èƒ½å¤Ÿæ­£å¸¸æ˜¾ç¤ºï¼š

- ğŸ—“ï¸ **æ•°æ®å®Œæ•´æ€§**ï¼šæ‰€æœ‰ 7 å¤©çš„æ•°æ®éƒ½èƒ½æ­£ç¡®è§£æå’Œæ˜¾ç¤º
- ğŸ”„ **å®æ—¶æ›´æ–°**ï¼šæ•°æ®åˆ·æ–°æ—¶ç«‹å³æ¸…ç©ºç¼“å­˜ç¡®ä¿æœ€æ–°å†…å®¹
- ğŸ¨ **ç•Œé¢æµç•…**ï¼šä¿æŒä¼˜åŒ–çš„æ¸²æŸ“æ€§èƒ½
- ğŸ› **é—®é¢˜è·Ÿè¸ª**ï¼šè¯¦ç»†æ—¥å¿—å¸®åŠ©å®šä½é—®é¢˜
- âš¡ **å“åº”è¿…é€Ÿ**ï¼šå¼‚æ­¥å¤„ç†ç¡®ä¿ UI ä¸å¡é¡¿

å‘¨å››çš„ 8 ä¸ªè§†é¢‘é¡¹ç›®ç°åœ¨åº”è¯¥èƒ½å¤Ÿæ­£å¸¸æ˜¾ç¤ºåœ¨æ’æœŸè¡¨ä¸­ï¼âœ¨
