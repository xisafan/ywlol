# 头像功能完善说明

## 🎯 已完成的功能

### 1. 完善头像上传功能

- ✅ 支持 jpg、jpeg、png、gif、webp 格式
- ✅ 文件大小限制 5MB
- ✅ 自动删除旧头像文件（避免存储浪费）
- ✅ 相对路径自动转换为完整 URL

### 2. QQ 头像缓存机制

- ✅ 自动缓存 QQ 头像到服务器本地
- ✅ 缓存有效期 7 天，避免频繁下载
- ✅ 支持手动刷新缓存
- ✅ 更新 QQ 号时自动缓存头像

### 3. 前端头像显示优化

- ✅ 优先显示缓存的头像
- ✅ 统一头像显示逻辑（首页、个人中心、我的界面）
- ✅ 错误处理和默认头像回退
- ✅ 支持头像实时上传和更新

## 🔧 新增 API 接口

### 1. 头像上传

```
POST /v1/user/upload_avatar
Content-Type: multipart/form-data
Headers: Authorization: Bearer {token}

Body:
- avatar: 图片文件
```

### 2. QQ 头像缓存

```
POST/GET /v1/user/cache_qq_avatar
Headers: Authorization: Bearer {token}
```

## 📂 文件结构

```
houduan/
├── uploads/
│   └── avatar/           # 头像存储目录
│       ├── avatar_1_xxx.jpg    # 用户上传头像
│       └── qq_avatar_1_qq.jpg  # 缓存的QQ头像
└── api/
    └── controllers/
        └── UserController.php  # 头像处理逻辑
```

## 🎨 前端实现

### 1. 头像显示逻辑（所有页面统一）

```dart
// 优先显示用户头像（包括缓存的QQ头像）
if (user.avatar != null && user.avatar!.isNotEmpty) {
  // 自动处理相对路径转换为完整URL
  String avatarUrl = processAvatarUrl(user.avatar!);
  return Image.network(avatarUrl);
} else {
  // 显示默认头像
  return Image.asset('assets/image/touxiang.jpg');
}
```

### 2. 头像上传

- 📱 支持相册选择和拍照
- 🔄 实时更新用户状态
- ✅ 成功反馈和错误处理

### 3. QQ 头像缓存

- 🔄 手动刷新缓存功能
- ⚡ 自动缓存（设置 QQ 号时）
- 📱 用户友好的提示信息

## 📱 用户使用流程

### 头像上传

1. 进入个人信息页面
2. 点击头像区域
3. 选择"从相册选择"或"拍照"
4. 确认选择并上传
5. 头像自动更新到各个页面

### QQ 头像缓存

1. 设置 QQ 号（自动触发缓存）
2. 或在个人信息页面点击"刷新 QQ 头像缓存"
3. 系统自动下载并保存 QQ 头像
4. 后续访问直接使用本地缓存

## 🛡️ 安全和性能

### 安全措施

- ✅ 文件格式验证
- ✅ 文件大小限制
- ✅ 上传路径安全检查
- ✅ 用户权限验证

### 性能优化

- ⚡ QQ 头像本地缓存，减少网络请求
- 🗂️ 自动清理旧文件，节省存储空间
- 📊 缓存有效期管理
- 🔄 异步处理，不阻塞主流程

## 📚 技术细节

### 后端改进

- 增强了 UserController 头像处理功能
- 实现了 QQ 头像下载和缓存机制
- 添加了文件管理和清理功能
- 完善了错误处理和日志记录

### 前端改进

- 统一了所有页面的头像显示逻辑
- 完善了头像上传流程
- 实现了实时状态更新
- 优化了用户体验和错误处理

### 数据库

- 使用现有的 mac_user 表的 user_portrait 字段
- 头像路径存储为相对路径，便于服务器迁移
- 支持完整 URL 和相对路径两种格式

## 🎯 使用建议

1. **首次设置**：建议用户先设置 QQ 号，系统会自动缓存 QQ 头像
2. **个性化头像**：可随时上传自定义头像覆盖 QQ 头像
3. **头像更新**：QQ 头像会自动刷新，缓存 7 天有效期
4. **存储管理**：系统自动清理旧头像文件，无需手动维护

